%% This script reconstruct 75K source signal using sLORETA, WMNE, LCMV
%% using brainstorm toolbox :https://neuroimage.usc.edu/brainstorm/
%% WRITTEN BY: PARINTHORN MANOMAISAOWAPAK
clear
clc
nVertices = 75000;

%%

ProtocolName = 'act_10_deep_2_nelec_61_constraint75k_fixtime_with_noise_cov';
gui_brainstorm('CreateProtocol', ProtocolName, 0,0)
for ii=1:100
    sFiles = [];
    SubjectNames = {...
        strcat('subject_',num2str(ii))};
    RawFiles = {...
        ['G:\Shared drives\MASTER_DRIVE\Journal\DATA\experiment_paper_L_augment\data_for_brainstorm\data',int2str(ii),'.mat'],... % EEG data
        'G:\Shared drives\MASTER_DRIVE\Journal\Source_Localization\NYHead\channel_61.mat'};
    AnatFiles = {...
        'G:\Shared drives\MASTER_DRIVE\Journal\Source_Localization\NYHead\subjectimage_T1.mat',...           % Directory of MRI file (subjectimage_T1.mat)
        'G:\Shared drives\MASTER_DRIVE\Journal\Source_Localization\NYHead\tess_scalp_150618_2140.mat',...    % Directory of Scalp
        'G:\Shared drives\MASTER_DRIVE\Journal\Source_Localization\NYHead\tess_cortex_01.mat'                % Directory of Cortex
        };
    bst_report('Start', sFiles);
    %add MRI files
    sFiles = bst_process('CallProcess', 'process_import_mri', sFiles, [], ...
        'subjectname', SubjectNames{1}, ...
        'mrifile',     {AnatFiles{1}, 'BST'}, ...
        'nas',         [0, 0, 0], ...
        'lpa',         [0, 0, 0], ...
        'rpa',         [0, 0, 0], ...
        'ac',          [0, 0, 0], ...
        'pc',          [0, 0, 0], ...
        'ih',          [0, 0, 0]);
    %add surface files
    sFiles = bst_process('CallProcess', 'process_import_surfaces', sFiles, [], ...
        'subjectname', SubjectNames{1}, ...
        'headfile',    {AnatFiles{2}, 'ALL'}, ...
        'cortexfile1', {AnatFiles{3}, 'ALL'}, ...
        'nvertcortex', {nVertices,'',0} ...
        );
    % Create link to raw file
    ImportEegRawOptions = bst_get('ImportEegRawOptions');
    ImportEegRawOptions.SamplingRate = 100;
    bst_set('ImportEegRawOptions', ImportEegRawOptions);
    sFiles = bst_process('CallProcess', 'process_import_data_raw', sFiles, [], ...
        'subjectname',    SubjectNames{1}, ...
        'datafile',       {RawFiles{1}, 'EEG-MAT'}, ...
        'channelreplace', 1, ...
        'channelalign',   1, ...
        'evtmode',        'value');
    % Get subject index
                        iSubject = ii;
    % add electrode system
    sFiles = bst_process('CallProcess', 'process_import_channel', sFiles, [], ...
        'channelfile', {RawFiles{2}, 'BST'}, ...
        'usedefault',  1, ...  %
        'fixunits',    1, ...
        'vox2ras',     1);
    % Process: Refine registration
    sFiles = bst_process('CallProcess', 'process_headpoints_refine', sFiles, []);
    % Process: Project electrodes on scalp
    sFiles = bst_process('CallProcess', 'process_channel_project', sFiles, [], ...
        'sensortypes', 'EEG');
    % add head model
    % Process: Compute head model
    sFiles = bst_process('CallProcess', 'process_headmodel', sFiles, [], ... % in_bst_headmodel(HeadModelFile, ApplyOrient, varargin)
        'Comment',     '', ...
        'sourcespace', 1, ...  % Cortex surface
        'volumegrid',  struct(...
        'Method',        'isotropic', ...
        'nLayers',       17, ...
        'Reduction',     3, ...
        'nVerticesInit', 4000, ...
        'Resolution',    0.005, ...
        'FileName',      []), ...
        'meg',         3, ...  % Overlapping spheres
        'eeg',         2, ...  % 3-shell sphere
        'ecog',        2, ...  % OpenMEEG BEM
        'seeg',        2, ...  % OpenMEEG BEM
        'openmeeg',    struct(...
        'BemFiles',     {{}}, ...
        'BemNames',     {{'Scalp', 'Skull', 'Brain'}}, ...
        'BemCond',      [1, 0.0125, 1], ...
        'BemSelect',    [1, 1, 1], ...
        'isAdjoint',    0, ...
        'isAdaptative', 1, ...
        'isSplit',      0, ...
        'SplitLength',  4000), ...
        'duneuro',     struct(...
        'FemCond',            [], ...
        'FemSelect',          [], ...
        'UseTensor',          0, ...
        'Isotropic',          1, ...
        'SrcShrink',          0, ...
        'FemType',            'fitted', ...
        'SolverType',         'cg', ...
        'GeometryAdapted',    0, ...
        'Tolerance',          1e-08, ...
        'ElecType',           'normal', ...
        'MegIntorderadd',     0, ...
        'MegType',            'physical', ...
        'SolvSolverType',     'cg', ...
        'SolvPrecond',        'amg', ...
        'SolvSmootherType',   'ssor', ...
        'SolvIntorderadd',    0, ...
        'DgSmootherType',     'ssor', ...
        'DgScheme',           'sipg', ...
        'DgPenalty',          20, ...
        'DgEdgeNormType',     'houston', ...
        'DgWeights',          1, ...
        'DgReduction',        1, ...
        'SolPostProcess',     1, ...
        'SolSubstractMean',   0, ...
        'SolSolverReduction', 1e-10, ...
        'SrcModel',           'venant', ...
        'SrcIntorderadd',     0, ...
        'SrcIntorderadd_lb',  2, ...
        'SrcNbMoments',       3, ...
        'SrcRefLen',          20, ...
        'SrcWeightExp',       1, ...
        'SrcRelaxFactor',     6, ...
        'SrcMixedMoments',    1, ...
        'SrcRestrict',        1, ...
        'SrcInit',            'closest_vertex', ...
        'BstSaveTransfer',    0, ...
        'BstEegTransferFile', 'eeg_transfer.dat', ...
        'BstMegTransferFile', 'meg_transfer.dat', ...
        'BstEegLfFile',       'eeg_lf.dat', ...
        'BstMegLfFile',       'meg_lf.dat'));

    % Process: Compute covariance
    % NOISE
    sFiles = bst_process('CallProcess', 'process_noisecov', sFiles, [], ...
        'baseline',       [0, 2.5], ... %179.99
        'datatimewindow', [0, 2.5], ...
        'sensortypes',    'MEG, EEG, SEEG, ECOG', ...
        'target',         1, ...  % Noise covariance     (covariance over baseline time window)
        'dcoffset',       1, ...  % Block by block, to avoid effects of slow shifts in data
        'identity',       0, ... % noise covariance structure (identity)
        'copycond',       0, ...
        'copysubj',       0, ...
        'copymatch',      0, ...
        'replacefile',    1);  % Replace
    % DATA
    sFiles = bst_process('CallProcess', 'process_noisecov', sFiles, [], ...
        'baseline',       [0, 2.5], ...
        'datatimewindow', [0, 2.5], ...
        'sensortypes',    'MEG, EEG, SEEG, ECOG', ...
        'target',         2, ...  % Data covariance      (covariance over data time window)
        'dcoffset',       1, ...  % Block by block, to avoid effects of slow shifts in data
        'identity',       0, ...
        'copycond',       0, ...
        'copysubj',       0, ...
        'copymatch',      0, ...
        'replacefile',    1);  % Replace

    EEGFiles = sFiles;

    % Process: Compute sources [2018] (Minnorm/Current density map)
    sFiles = bst_process('CallProcess', 'process_inverse_2018', EEGFiles, [], ...
        'output',  1, ...  % Kernel only: shared
        'inverse', struct(...
        'Comment',        'MN: EEG', ...
        'InverseMethod',  'minnorm', ...
        'InverseMeasure', 'amplitude', ...
        'SourceOrient',   {{'fixed'}}, ...
        'Loose',          0.2, ...
        'UseDepth',       1, ...
        'WeightExp',      0.5, ...
        'WeightLimit',    10, ...
        'NoiseMethod',    'reg', ...
        'NoiseReg',       0.1, ...
        'SnrMethod',      'fixed', ...
        'SnrRms',         1e-06, ...
        'SnrFixed',       3, ...
        'ComputeKernel',  1, ...
        'DataTypes',      {{'EEG'}}));

    % Screen Capture
    %     BS_ScreenCap(sFiles,iter,orients,methods{1},mainPath);

    % Process: Compute sources [2018] (LCMV Beamforming)
    sFiles = bst_process('CallProcess', 'process_inverse_2018', EEGFiles, [], ...
        'output',  1, ...  % Kernel only: shared
        'inverse', struct(...
        'Comment',        'PNAI: EEG', ...
        'InverseMethod',  'lcmv', ...
        'InverseMeasure', 'nai', ...
        'SourceOrient',   {{'fixed'}}, ...
        'Loose',          0.2, ...
        'UseDepth',       1, ...
        'WeightExp',      0.5, ...
        'WeightLimit',    10, ...
        'NoiseMethod',    'median', ...
        'NoiseReg',       0.1, ...
        'SnrMethod',      'rms', ...
        'SnrRms',         1e-06, ...
        'SnrFixed',       3, ...
        'ComputeKernel',  1, ...
        'DataTypes',      {{'EEG'}}));

    % Screen Capture
    %     BS_ScreenCap(sFiles,iter,orients,methods{2},mainPath);

    % Process: Compute sources [2018] (Minnorm/sLORETA)
    sFiles = bst_process('CallProcess', 'process_inverse_2018', EEGFiles, [], ...
        'output',  1, ...  % Kernel only: shared
        'inverse', struct(...
        'Comment',        'sLORETA: EEG', ...
        'InverseMethod',  'minnorm', ...
        'InverseMeasure', 'sloreta', ...
        'SourceOrient',   {{'fixed'}}, ...
        'Loose',          0.2, ...
        'UseDepth',       0, ...
        'WeightExp',      0.5, ...
        'WeightLimit',    10, ...
        'NoiseMethod',    'median', ...
        'NoiseReg',       0.1, ...
        'SnrMethod',      'fixed', ...
        'SnrRms',         0, ...
        'SnrFixed',       3, ...
        'ComputeKernel',  1, ...
        'DataTypes',      {{'EEG'}}));

    % Screen Capture
    %     BS_ScreenCap(sFiles,iter,orients,methods{3},mainPath);

    % Save Report
    ReportFile = bst_report('Save',sFiles);
end
